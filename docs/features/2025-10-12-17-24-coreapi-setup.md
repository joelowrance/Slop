# Task: CoreAPI Project Setup with OpenTelemetry, Serilog, and PostgreSQL

## Overview
This plan creates the CoreAPI project as the primary business logic backend for VerdaVidaLawnCare. The project will integrate with the existing Aspire infrastructure (PostgreSQL, RabbitMQ, MailHog) and implement comprehensive observability with OpenTelemetry and Serilog. A test endpoint will demonstrate all integrations working correctly.

## Architecture Components
- **CoreAPI**: Primary business logic backend service
- **PostgreSQL**: Database integration with Entity Framework Core
- **OpenTelemetry**: Distributed tracing and metrics collection
- **Serilog**: Structured logging with correlation IDs
- **Test Endpoint**: Demonstrates database, logging, and tracing functionality
- **Health Checks**: Service health monitoring
- **Result Pattern**: Consistent error handling and response patterns

---

## Commit 1: feat: create CoreAPI project structure with Aspire integration [docs/features/2025-01-27-coreapi-setup.md]
**Description:**
Create the CoreAPI project in `src/VerdaVidaLawnCare.CoreAPI/` using the web API template. Configure Aspire service hosting, dependency injection, and basic project structure following the established architecture patterns.

**Implementation Details:**
- Create CoreAPI project with web API template
- Configure Aspire service hosting integration
- Set up dependency injection container
- Add project references to VerdaVida.Shared
- Configure basic middleware pipeline
- Add project to solution file
- Set up launch profiles

**Verification:**
1. **Automated Test(s):**
   * **Command:** `dotnet build src/VerdaVidaLawnCare.CoreAPI/`
   * **Expected Outcome:** `Build succeeded` with no errors
2. **Logging Check:**
   * **Action:** `dotnet run --project src/VerdaVidaLawnCare.CoreAPI/`
   * **Expected Log:** `Now listening on: https://localhost:7001` (CoreAPI service)
   * **Toggle Mechanism:** N/A (project creation verification)

---

## Commit 2: feat: configure Entity Framework Core with PostgreSQL integration [docs/features/2025-01-27-coreapi-setup.md]
**Description:**
Configure Entity Framework Core with PostgreSQL provider, connection string management, and database context. Set up proper configuration for development and production environments.

**Implementation Details:**
- Add Entity Framework Core packages
- Configure PostgreSQL connection string
- Create DbContext with proper configuration
- Set up connection string injection
- Configure Entity Framework logging
- Add database health checks
- Set up migration support

**Verification:**
1. **Automated Test(s):**
   * **Command:** `dotnet test tests/VerdaVidaLawnCare.UnitTests/ --filter DatabaseContextTests`
   * **Expected Outcome:** `Database context and connection tests pass`
2. **Logging Check:**
   * **Action:** Check CoreAPI logs for database connection
   * **Expected Log:** `Database connection established successfully`
   * **Toggle Mechanism:** `appsettings.json: "ConnectionStrings:DefaultConnection"`

---

## Commit 3: feat: implement OpenTelemetry distributed tracing and metrics [docs/features/2025-01-27-coreapi-setup.md]
**Description:**
Configure OpenTelemetry for distributed tracing, metrics collection, and correlation across the CoreAPI service. Set up proper instrumentation for HTTP requests, database operations, and custom business logic.

**Implementation Details:**
- Configure OpenTelemetry tracing in Program.cs
- Add HTTP request instrumentation
- Add database operation instrumentation
- Configure metrics collection
- Set up trace correlation IDs
- Add custom activity sources for business logic
- Configure OTLP exporter for Aspire dashboard

**Verification:**
1. **Automated Test(s):**
   * **Command:** `dotnet test tests/VerdaVidaLawnCare.UnitTests/ --filter OpenTelemetryTests`
   * **Expected Outcome:** `OpenTelemetry configuration and tracing tests pass`
2. **Logging Check:**
   * **Action:** Check Aspire dashboard for trace data
   * **Expected Log:** `Distributed traces visible for CoreAPI operations`
   * **Toggle Mechanism:** `appsettings.json: "OpenTelemetry:Enabled": true`

---

## Commit 4: feat: configure structured logging with Serilog and correlation IDs [docs/features/2025-01-27-coreapi-setup.md]
**Description:**
Configure Serilog for structured logging with JSON format, correlation ID tracking, and proper log levels. Set up centralized logging configuration and integration with OpenTelemetry.

**Implementation Details:**
- Configure Serilog with JSON formatting
- Add correlation ID middleware
- Set up structured logging for all operations
- Configure log levels per environment
- Add request/response logging
- Integrate with OpenTelemetry trace correlation
- Set up log enrichment with service context

**Verification:**
1. **Automated Test(s):**
   * **Command:** `dotnet test tests/VerdaVidaLawnCare.UnitTests/ --filter LoggingTests`
   * **Expected Outcome:** `Structured logging configuration tests pass`
2. **Logging Check:**
   * **Action:** Trigger API requests and check logs
   * **Expected Log:** `{"Timestamp":"2025-01-27T10:00:00.000Z","Level":"Information","Message":"API request processed","Service":"CoreAPI","CorrelationId":"abc123","TraceId":"def456"}`
   * **Toggle Mechanism:** `appsettings.json: "Serilog:MinimumLevel:Default": "Information"`

---

## Commit 5: feat: create test entity and database operations [docs/features/2025-01-27-coreapi-setup.md]
**Description:**
Create a test entity (TestRecord) with Entity Framework configuration to demonstrate database operations. Implement repository pattern and basic CRUD operations following the established entity model template.

**Implementation Details:**
- Create TestRecord entity following entity model template
- Create EntityTypeConfiguration for TestRecord
- Implement repository interface and implementation
- Add database migration for TestRecord table
- Implement basic CRUD operations
- Add proper validation and error handling
- Follow Result pattern for operations

**Verification:**
1. **Automated Test(s):**
   * **Command:** `dotnet test tests/VerdaVidaLawnCare.UnitTests/ --filter TestRecordTests`
   * **Expected Outcome:** `TestRecord entity and repository tests pass`
2. **Logging Check:**
   * **Action:** Check database for TestRecord table creation
   * **Expected Log:** `TestRecord table created successfully with proper schema`
   * **Toggle Mechanism:** `appsettings.json: "Database:CreateTestTable": true`

---

## Commit 6: feat: implement test endpoint demonstrating all integrations [docs/features/2025-01-27-coreapi-setup.md]
**Description:**
Create a comprehensive test endpoint that demonstrates database operations, structured logging, OpenTelemetry tracing, and proper error handling. The endpoint will showcase all integrations working together.

**Implementation Details:**
- Create TestController with comprehensive test endpoint
- Implement database read/write operations
- Add structured logging throughout the operation
- Include OpenTelemetry custom activities
- Implement proper error handling with Result pattern
- Add request validation and response formatting
- Include performance metrics and timing

**Verification:**
1. **Automated Test(s):**
   * **Command:** `dotnet test tests/VerdaVidaLawnCare.UnitTests/ --filter TestEndpointTests`
   * **Expected Outcome:** `Test endpoint functionality tests pass`
2. **Logging Check:**
   * **Action:** `curl -X POST https://localhost:7001/api/test/demonstrate`
   * **Expected Log:** `{"Level":"Information","Message":"Test endpoint executed successfully","Operation":"DatabaseWrite","Duration":"45ms","TraceId":"xyz789"}`
   * **Toggle Mechanism:** `appsettings.json: "TestEndpoint:Enabled": true`

---

## Commit 7: feat: add health checks and monitoring endpoints [docs/features/2025-01-27-coreapi-setup.md]
**Description:**
Implement comprehensive health checks for database connectivity, external dependencies, and service health. Add monitoring endpoints for observability and service status.

**Implementation Details:**
- Add database health checks
- Implement custom health check for business logic
- Add readiness and liveness probes
- Create health check endpoints
- Configure health check UI
- Add dependency health monitoring
- Set up health check metrics

**Verification:**
1. **Automated Test(s):**
   * **Command:** `dotnet test tests/VerdaVidaLawnCare.UnitTests/ --filter HealthCheckTests`
   * **Expected Outcome:** `Health check configuration and functionality tests pass`
2. **Logging Check:**
   * **Action:** `curl https://localhost:7001/health`
   * **Expected Log:** `{"Status":"Healthy","Checks":{"Database":"Healthy","Service":"Healthy"},"Duration":"12ms"}`
   * **Toggle Mechanism:** `appsettings.json: "HealthChecks:Enabled": true`

---

## Commit 8: feat: integrate CoreAPI with AppHost orchestration [docs/features/2025-01-27-coreapi-setup.md]
**Description:**
Integrate the CoreAPI project with the existing AppHost orchestration. Configure service discovery, dependency references, and proper startup order with infrastructure services.

**Implementation Details:**
- Add CoreAPI project reference to AppHost
- Configure PostgreSQL connection reference
- Configure RabbitMQ connection reference
- Set up service discovery
- Configure proper startup dependencies
- Add service health monitoring
- Set up inter-service communication

**Verification:**
1. **Automated Test(s):**
   * **Command:** `dotnet run --project src/VerdaVidaLawnCare.AppHost/`
   * **Expected Outcome:** `CoreAPI service starts successfully with all dependencies`
2. **Logging Check:**
   * **Action:** Check Aspire dashboard for CoreAPI service
   * **Expected Log:** `CoreAPI service healthy and connected to PostgreSQL and RabbitMQ`
   * **Toggle Mechanism:** `AppHost.cs: CoreAPI project reference enabled`

---

## Commit 9: test: create comprehensive integration tests for CoreAPI [docs/features/2025-01-27-coreapi-setup.md]
**Description:**
Create comprehensive integration tests to verify all CoreAPI functionality including database operations, logging, tracing, and endpoint functionality. Use TestContainers for isolated testing.

**Implementation Details:**
- Create integration test project
- Implement TestContainers for PostgreSQL
- Test database operations end-to-end
- Test OpenTelemetry tracing
- Test structured logging output
- Test health check endpoints
- Test error handling scenarios

**Verification:**
1. **Automated Test(s):**
   * **Command:** `dotnet test tests/VerdaVidaLawnCare.IntegrationTests/ --filter CoreAPITests`
   * **Expected Outcome:** `All CoreAPI integration tests pass`
2. **Logging Check:**
   * **Action:** `dotnet test --logger "console;verbosity=detailed"`
   * **Expected Log:** `{"Level":"Information","Message":"Integration test completed","TestName":"CoreAPI_ShouldWorkWithAllIntegrations","Duration":"3.2s"}`
   * **Toggle Mechanism:** `appsettings.Test.json: "Logging:LogLevel:Default": "Information"`

---

## Commit 10: docs: create CoreAPI setup and usage documentation [docs/features/2025-01-27-coreapi-setup.md]
**Description:**
Create comprehensive documentation for the CoreAPI project including setup instructions, API documentation, configuration guide, and development workflows.

**Implementation Details:**
- Create README.md for CoreAPI project
- Document API endpoints and usage
- Create configuration guide
- Document database schema and migrations
- Create troubleshooting guide
- Add architecture diagrams
- Document testing procedures

**Verification:**
1. **Automated Test(s):**
   * **Command:** `dotnet build` (verify all projects still build)
   * **Expected Outcome:** `Build succeeded` for all projects
2. **Logging Check:**
   * **Action:** `cat src/VerdaVidaLawnCare.CoreAPI/README.md | grep -i "api\|database\|logging\|tracing"`
   * **Expected Log:** `Documentation contains references to all CoreAPI features`
   * **Toggle Mechanism:** N/A (documentation verification)

---

## Service Endpoints and Access Points

### CoreAPI Service
- **URL:** `https://localhost:7001`
- **Purpose:** Primary business logic backend
- **Features:** REST API, database operations, health checks

### Test Endpoint
- **URL:** `https://localhost:7001/api/test/demonstrate`
- **Method:** `POST`
- **Purpose:** Demonstrates all integrations working
- **Response:** JSON with operation results and timing

### Health Check Endpoints
- **Health:** `https://localhost:7001/health`
- **Ready:** `https://localhost:7001/health/ready`
- **Live:** `https://localhost:7001/health/live`
- **Purpose:** Service health monitoring

### Database Connection
- **Provider:** PostgreSQL via Entity Framework Core
- **Connection:** Managed by Aspire service discovery
- **Migrations:** Automatic via EF Core migrations

## Configuration Files

### CoreAPI Configuration
- `src/VerdaVidaLawnCare.CoreAPI/Program.cs` - Main application setup
- `src/VerdaVidaLawnCare.CoreAPI/appsettings.json` - Service configuration
- `src/VerdaVidaLawnCare.CoreAPI/appsettings.Development.json` - Development overrides

### Database Configuration
- Connection strings managed by Aspire
- Entity Framework configuration
- Migration scripts and schema management

### Observability Configuration
- OpenTelemetry tracing configuration
- Serilog structured logging setup
- Health check configuration

## Development Workflow

1. **Start Infrastructure:** `dotnet run --project src/VerdaVidaLawnCare.AppHost/`
2. **Access CoreAPI:** Navigate to `https://localhost:7001`
3. **Test Endpoint:** `curl -X POST https://localhost:7001/api/test/demonstrate`
4. **Check Health:** `curl https://localhost:7001/health`
5. **View Logs:** Check Aspire dashboard for structured logs
6. **View Traces:** Use Aspire dashboard for distributed tracing
7. **Monitor Metrics:** Check Aspire dashboard for performance metrics

## Security Considerations

- All endpoints use HTTPS in production
- Database connections use service discovery
- Structured logging excludes sensitive data
- Health checks don't expose internal details
- OpenTelemetry traces can be filtered for sensitive operations
- Consider implementing authentication/authorization for production

## Performance Considerations

- Database operations use async/await patterns
- OpenTelemetry instrumentation has minimal overhead
- Structured logging is optimized for performance
- Health checks are lightweight and fast
- Connection pooling configured for database operations
- Consider implementing caching for frequently accessed data
